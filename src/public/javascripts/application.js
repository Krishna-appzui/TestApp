/*! DecisionsConsole 2014-10-21 */
function FunctionStack(){this.arr=[]}function SocketStreamQuery(a){this.parameters=a,this.first=null,this.last=null,this.stack=new FunctionStack,(void 0===this.parameters.pageSize||null===this.parameters.pageSize)&&(this.parameters.pageSize=500),(void 0===this.parameters.maxResults||null===this.parameters.maxResults)&&(this.parameters.maxResults=-1),(void 0===this.parameters.itemType||null===this.parameters.pageSize)&&console.log("Attempt to create SocketStreamQuery with no item type")}function DimensionTreeView(a){this.attributes=a.attributes,this.dimensionsByPath={};var b=this;this.schemaField=a.schemaField;var c=new DynamicTreeView({el:a.el}).render();c.nodePressedHandler=function(a){a.isLeaf()||(a.isLoaded()?a.toggleExpanded():(a.setExpanded(!0),b.loadNodeChildren(a)))},c.nodeSelectedHandler=function(c){var d=$(c.target),e=d.closest("li"),f=e.data("path");if(!_.isUndefined(a.selectedHandler)){var g=b.dimensionsByPath[f];a.selectedHandler(g)}};var d=$(".tree-root");void 0!==a.path?d.closest("li").data("path",a.path):void 0!==a.level&&d.closest("li").data("level",a.level),this.rootNode=new DynamicTreeNode(d),a.expanded===!0?(this.rootNode.setExpanded(!0),this.loadNodeChildren(this.rootNode)):this.rootNode.setExpanded(!1)}function DynamicTreeNode(a){this.el=a}App={navBar:null,templates:{},currentPage:null,currentPageId:null,modalPage:null,views:{},router:null,presentModalPage:function(pageId,data){var template=this.templates[pageId].clone();if(null!==template&&void 0!==template){template.modal({backdrop:!0,keyboard:!0,show:!1});var instance=null,viewName=null;try{viewName=eval(pageId)}catch(e){}null!==viewName&&void 0!==viewName&&(instance=new viewName({el:template,data:data}),null!==instance&&void 0!==instance&&("function"==typeof instance.init&&instance.init(),this.modalPage=instance,template.modal("show"),template.on("show.bs.modal",function(){"function"==typeof instance.willShow&&instance.willShow()}),template.on("shown.bs.modal",function(){"function"==typeof instance.didShow&&instance.didShow()}),template.on("hide.bs.modal",function(){"function"==typeof instance.willHide&&instance.willHide()}),template.on("hidden.bs.modal",function(){"function"==typeof instance.didHide&&instance.didHide(),template.remove(),template.unbind()})))}},loadPage:function(pageParams,data){var components=pageParams.split(":"),pageId=components[0],param=components.length>1?components[1]:null;if(this.currentPageId!==pageId){App.auth.hasCredentials()||(pageId="LoginView"),null!==this.currentPage&&("function"==typeof this.currentPage.willHide&&this.currentPage.willHide(),$("#RootView").hide(),$(this.currentPage.el).remove(),$(this.currentPage.el).unbind(),"function"==typeof this.currentPage.didHide&&this.currentPage.didHide());var template=this.templates[pageId];if(null!==template&&void 0!==template){Backbone.history.navigate("#"+pageParams,{trigger:!1}),$("#RootView").html(template.clone());var page=$("#RootView #"+pageId);$("#RootView").show(),page.show();var instance=null,viewName=null;try{viewName=eval(pageId)}catch(e){console.log("Unknown Page: "+e)}if(null!==viewName&&void 0!==viewName){data=_.isUndefined(data)?{param:param}:_.extend(data,{param:param});try{instance=new viewName({el:page,data:data})}catch(e){console.log("Page does not exist: "+pageId)}null!==instance&&void 0!==instance&&(this.currentPage=instance,this.currentPageId=pageId,"function"==typeof instance.willShow&&instance.willShow(),"function"==typeof instance.didShow&&instance.didShow())}}}},setupSocket:function(){App.socket=io.connect(),App.socket.query=function(a,b,c){void 0===b.community&&(b.community=App.auth.getCommunity()),void 0===b.token&&(b.token=App.auth.getToken()),void 0===b.userId&&(b.userId=App.auth.getUserId()),void 0===b.sid&&(b.sid=App.auth.getSid()),b.queryKey=App.utils.newUID();var d=a+":callback:"+b.queryKey;App.socket.once(d,function(a){var b="undefined"!=typeof a.err&&null!==a.err?new Error(a.err):null;c(b,a.result)}),App.socket.emit(a,b)}},initSignIn:function(){console.log("Signin Init"),App.config.options={},window.location.hash="";var a=$("#RootView #LoginView"),b=new LoginView({el:a});this.currentPage=b,"function"==typeof b.willShow&&b.willShow(),"function"==typeof b.didShow&&b.didShow(),$("body").show(),this.setupSocket()},init:function(a){return this.setupSocket(),console.log("Application Init"),App.config.setData(a),App.auth.hasCredentials()?void this.startRouter():void(window.location.href="/signin")},startRouter:function(){var a=this;$('div[data-role="page"]').each(function(b,c){var d=$(c).attr("id");a.templates[d]=$(c).detach()}),$('div[data-role="view"]').each(function(b,c){var d=$(c).attr("id");a.templates[d]=$(c).detach()}),App.auth.init(),this.scrollViews=[];var b=Backbone.Router.extend({routes:{"*actions":"defaultRoute"}}),a=this;this.router=new b,this.router.on("route:defaultRoute",function(b){(_.isUndefined(b)||_.isNull(b))&&(b=_.isUndefined(App.config.page)?"LibraryView":App.config.page),(_.isUndefined(App.config.page)||0===App.config.page.length)&&(App.config.page="LibraryView"),a.loadPage(b)}),this.navBar=new NavBarView({el:$("#mainNavBar")}),this.navBar.init(),this.navBar.willShow(),Backbone.History.started||Backbone.history.start(),$("body").show(),this.navBar.didShow()}},$(document).ready(function(){Validation.extend()});var DimensionManager={depthForPathOrLevel:function(a){if("undefined"==typeof a||null===a||-1==a.indexOf("/"))return 0;var b=_.reject(a.split("/"),function(a){return 0===a.length});return b.length-1},parentPathForDepth:function(a,b){if(_.isUndefined(a)||_.isNull(a))return 0;var c=_.reject(a.split("/"),function(a){return 0===a.length}),d=_.reduce(c.slice(0,b+1),function(a,b){return a+"/"+b},"");return d},dimensionForPath:function(a,b){void 0!==b&&App.socket.query("dimension",{query:"dimensionsForPaths",paths:[a]},function(a,c){b(c)})},dimensionsForPaths:function(a,b){void 0!==b&&App.socket.query("dimension",{query:"dimensionsForPaths",paths:a},function(a,c){b(c)})},dimensionsAtLevel:function(a,b,c){void 0!==c&&App.socket.query("dimension",{query:"dimensionsAtLevel",attributes:b,level:a},function(a,b){c(b)})},childDimensionsForLevel:function(a,b,c){void 0!==c&&App.socket.query("dimension",{query:"childDimensionsForLevel",attributes:b,level:a},function(a,b){c(b)})},childDimensionsForPath:function(a,b,c){void 0!==c&&App.socket.query("dimension",{query:"childDimensionsForPath",attributes:b,path:a},function(a,b){c(b)})},valueForComplexKey:function(a,b){var c=_.isUndefined(a.data)?a:a.data;if(-1===b.indexOf("/"))return c[b];if(-1!==b.indexOf("[")&&-1!==b.indexOf("=")){var d=b.match(/(.*?)\[/)[1],e=b.match(/\[(.*?\])/)[1].split("="),f=Item.findBlock(c[d],e[0],e[1]),g=_.last(b.split("/"));return _.isUndefined(f)?void 0:f.data[g]}},parseAttributes:function(a,b){if(_.isUndefined(b.dimensionAttributes)||_.isNull(b.dimensionAttributes))return null;var c=this,d=[];return b.dimensionAttributes.forEach(function(b){var e=b.pathStartsWith,f=(b.attribute,b.value),g=b.field,h=b.level,i=(b.blockField,b.custom),j={field:g,attribute:b.attribute};if(_.isUndefined(i))if(_.isUndefined(f)){if(!_.isUndefined(g))if(_.isUndefined(e))if(_.isUndefined(h))j.value=c.valueForComplexKey(a.data,g);else{var k=c.depthForPathOrLevel(h),l=c.parentPathForDepth(a.data[g],k);j.level=h,j.value=l}else{var k=c.depthForPathOrLevel(h),l=c.parentPathForDepth(a.data[g],k);j.value=l,j.pathStartsWith=!0}}else j.value=f;else j.custom=i,_.isUndefined(g)||(j.value=c.valueForComplexKey(a.data,g));d.push(j)}),d}},Edit={MediaAbstract:{fields:[{field:"description",label:"Title",type:"text"},{field:"tags",label:"Tags",type:"text"},{field:"link",label:"Link",type:"text"},{nameField:"name",otherNameField:"fileName",sizeField:"fileSize",type:"file"},{field:"mediaType",label:"Media Type",type:"dimension",dimensionLevel:"/Data/mediaType"}]}};FunctionStack.prototype.push=function(a){return 0===this.arr.length?(this.arr.push(a),void a()):void this.arr.push(a)},FunctionStack.prototype.callNext=function(){0!==this.arr.length&&(this.arr.shift(),0!==this.arr.length&&"function"==typeof this.arr[0]&&this.arr[0]())},Indicator={spinner:function(){return $('<div data-role="spinner"><div class="spinner dashes spinner-large-blue">             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>          </div></div>')},config:function(){return{message:this.spinner(),css:{border:"none",padding:"15px",backgroundColor:"transparent","-webkit-border-radius":"10px","-moz-border-radius":"10px",centerX:!0,centerY:!0,opacity:1,color:"#000","font-family":"Sans-serif","letter-spacing":".5px","font-size":"16px","font-weight":"bold"},overlayCSS:{backgroundColor:"#fff"}}},block:function(a){a.block(this.config())},unblock:function(a){a.unblock()},start:function(){$.blockUI(this.config())},stop:function(){$.unblockUI()},alert:function(a){a&&"undefined"!=a&&$.jGrowl(a,{life:4e3,color:"blue"})},stickyAlert:function(a){a&&"undefined"!=a&&$.jGrowl(a,{sticky:!0,life:4e3,icon:"glyphicon glyphicon-bell",color:"blue"})},success:function(a){a&&"undefined"!=a&&$.jGrowl("&nbsp;"+a,{life:5e3,icon:"glyphicon glyphicon-ok",color:"green"})},info:function(a){a&&"undefined"!=a&&$.jGrowl("&nbsp;"+a,{life:5e3,icon:"glyphicon glyphicon-info-sign",color:"orange"})},danger:function(a){a&&"undefined"!=a&&$.jGrowl("&nbsp;"+a,{life:5e3,icon:"glyphicon glyphicon-bell",color:"red"})}};var Item={valueForComplexKey:function(a,b){var c=_.isUndefined(a.data)?a:a.data;if(-1===b.indexOf("/"))return c[b];if(-1!==b.indexOf("[")&&-1!==b.indexOf("=")){var d=b.match(/(.*?)\[/)[1],e=b.match(/\[(.*?\])/)[1].split("="),f=this.findBlock(c[d],e[0],e[1]),g=_.last(b.split("/"));return _.isUndefined(f)?void 0:f.data[g]}},findBlock:function(a,b,c){return _.find(a,function(a){return a.data[b]===c})}},Mediator=function(){var a=function(a,b,c){return Mediator.channels[a]||(Mediator.channels[a]=[]),Mediator.channels[a].push({context:c,callback:b}),this},b=function(a){if(!Mediator.channels[a])return!1;for(var b=Array.prototype.slice.call(arguments,1),c=0,d=Mediator.channels[a].length;d>c;c++){var e=Mediator.channels[a][c];e.callback.apply(e.context,b)}return this};return{channels:{},publish:b,subscribe:a,installTo:function(c){c.subscribe=a,c.publish=b}}}(),SocketStream={fetchAll:function(a,b){var c=new SocketStreamQuery(a);c.fetchAll(function(a){b(a)})}};SocketStreamQuery.prototype.sendQueryRequest=function(a,b){if(null!==b&&void 0!==b){var c=_.cloneDeep(this.parameters);void 0!==a&&null!==a&&(c.startWith=a),App.socket.query("query",c,function(a,c){b(c)})}},SocketStreamQuery.prototype._fetchAll=function(a,b){var c=this.parameters.maxResults;if(-1!==c&&a.length>=c)return void b(a);var d=this;this.next(function(c,e){if(void 0===c||null===c)b(a);else{for(var f=0;f<c.length;f++)a.push(c[f]);e===!0?b(a):d._fetchAll(a,b)}})},SocketStreamQuery.prototype.fetchAll=function(a){this._fetchAll([],a)},SocketStreamQuery.prototype.next=function(a){if(null!==a&&void 0!==a){var b=this;this.stack.push(function(){b.sendQueryRequest(b.last,function(c){if(null===c||void 0===c||void 0===c.items)return void a(null);b.last={key:c.lastKey,id:c.lastId},b.first={key:c.firstKey,id:c.firstId};var d=!1;(0===c.items.length||c.items.length<b.parameters.pageSize)&&(d=!0),a(c.items,d),b.stack.callNext()})})}},App.utils={newUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},newUID:function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)},newTimeStamp:function(){return""+(new Date).getTime()},isoTimestamp:function(){return moment(new Date).format()},longTimestamp:function(){return(new Date).getTime()},numberWithCommas:function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},fileSizeString:function(a){if(void 0===a||null===a||0===a.length)return"N/A";var b=a.valueOf();return b>1048576?Math.round(b/1048576*100)/100+" Mbytes":b>1024?Math.round(b/1024*100)/100+" Kbytes":this.numberWithCommas(b)+" bytes"},unCamelCase:function(a){return a.replace(/([A-Z])/g," $1").replace(/^./,function(a){return a.toUpperCase()})}};var Validation={extend:function(){$.validator.addMethod("conditionalRequired",function(a,b,c){if(_.isUndefined(c.field)||_.isUndefined(c.formView))return!0;var d=c.formView.diff[c.field];return"same"===d?!0:(c.message=_.isUndefined(c.message)?"This field is required because you modified "+App.utils.unCamelCase(c.field):c.message,0!==$(b).val().length)},function(a){return a.message}),$.validator.addMethod("usAndCdnPostal",function(a,b,c){return c.message=_.isUndefined(c.message)?"Please specify a valid Postal Code for your selected country. (US)":c.message,this.optional(b)||a.match(/(^[ABCEGHJKLMNPRSTVXY]\d[ABCEGHJKLMNPRSTVWXYZ]( )?\d[ABCEGHJKLMNPRSTVWXYZ]\d$)|(^\d{5}(-\d{4})?$)/)},function(a){return a.message}),$.validator.addMethod("matchLevel",function(a,b,c){var d=c.formView;if(_.isUndefined(d)||_.isUndefined(c.field)||_.isUndefined(d.inputViews))return!0;var e=_.find(d.inputViews,function(a){return $.contains(a.el,b)}),f=_.isUndefined(e)||_.isUndefined(e.data)||_.isUndefined(e.data.item)?null:e.data.item.data[c.field];return this.optional(b)||-1!==e.data.selectedPath.indexOf(f)},function(a){return a.message}),$.validator.addMethod("usOrCdnPostal",function(a,b,c){var d=c.formView;if(_.isUndefined(d)||_.isUndefined(c.field)||_.isUndefined(d.inputViews))return!0;var e=_.find(d.inputViews,function(a){return $.contains(a.el,b)}),f=_.isUndefined(e)||_.isUndefined(e.data)||_.isUndefined(e.data.item)?null:e.data.item.data[c.field];switch(f){case"/Global/country[US]":return c.message=_.isUndefined(c.message)?"Please specify a valid Postal Code for your selected country. (US)":c.message,this.optional(b)||a.match(/(^\d{5}(-\d{4})?$)/);case"/Global/country[CA]":return c.message=_.isUndefined(c.message)?"Please specify a valid Postal Code for your selected country. (CA)":c.message,this.optional(b)||a.match(/(^[ABCEGHJKLMNPRSTVXY]\d[ABCEGHJKLMNPRSTVWXYZ]( )?\d[ABCEGHJKLMNPRSTVWXYZ]\d$)/);default:return this.optional(b)||a.match(/(^[ABCEGHJKLMNPRSTVXY]\d[ABCEGHJKLMNPRSTVWXYZ]( )?\d[ABCEGHJKLMNPRSTVWXYZ]\d$)|(^\d{5}(-\d{4})?$)/)}},function(a){return a.message})}};App.auth={lib:null,communities:null,rolesByCommunity:null,userInfo:null,init:function(){},setSid:function(a){$.cookie("sid",a)},getSid:function(){return $.cookie("sid")},setUserId:function(a){$.cookie("userId",a)},getUserId:function(){return $.cookie("userId")},setToken:function(a){$.cookie("token",a)},getToken:function(){return $.cookie("token")},setCommunity:function(a){$.cookie("community",a)},getCommunity:function(){return $.cookie("community")},setCredential:function(a,b){this.setUser(a),this.setToken(b)},hasCredentials:function(){var a=$.cookie("userId"),b=$.cookie("token"),c=$.cookie("community");return null!==a&&void 0!==a&&null!==b&&void 0!==b&&null!==c&&void 0!==c?!0:!1},logout:function(){$.cookie("user",null),$.cookie("token",null),$.cookie("community",null),window.location.href="/signin"},toUTF8:function(a){for(var b=a,c="",d=0;d<b.length;d++)0!=b.charCodeAt(d)&&(c+=b.charAt(d));return c}},App.condition={test:function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=b.data[d.field];if(e!==d.value)return!1}return!0}},App.config={protocol:"https",host:"ldcloud-dev.liquidanalytics.com",hash:"/ls/external/",logLevel:3},App.config.setData=function(a){this.options={};var b=this;Object.keys(a).forEach(function(c){b[c]=a[c]}),this.restUrl=App.config.protocol+"://"+App.config.host},App.config.webSocketUrl="ws://"+App.config.host,App.config.restUrl=App.config.protocol+"://"+App.config.host,App.context={arguments:{},items:{},setItem:function(a,b){this.items[b]=a},getItem:function(a){return this.items[a]}},App.Topic=function(a){this.topic=a,App.socket.emit("subscribe",{topic:this.topic,userId:App.auth.getUserId(),token:App.auth.getToken()})},App.Topic.prototype.subscribe=function(a){App.socket.on("message",function(b){var c="undefined"!=typeof b.err&&null!==b.err?new Error(b.err):null;a(c,b)})},App.Topic.prototype.publish=function(a){a.topic=this.topic,a.userId=App.auth.getUserId(),a.token=App.auth.getToken(),App.socket.emit("publish",a)},App.Topic.prototype.onJoin=function(a){App.socket.on("join",function(b){var c="undefined"!=typeof b.err&&null!==b.err?new Error(b.err):null;a(c,b)})},App.Topic.prototype.onLeave=function(a){App.socket.on("leave",function(b){var c="undefined"!=typeof b.err&&null!==b.err?new Error(b.err):null;a(c,b)})},App.media={restURL:App.config.protocol+"://"+App.config.host+App.config.hash,websocketURL:"ws://"+App.config.host,requestCommand:function(){this.url="",this.verb="",this.payloadText="",this.callBack="",this.errorHandler=""},sendPayload:function(a,b,c,d){if(console.warn("Sending Payload"),a=JSON.stringify({payloadText:a}),b=JSON.stringify({payloadText:b}),c=c.replace(/"/g,'\\"'),!d)var d="SubmitTransactions";var e=App.auth.getToken(),f='{		        "application": "LD Analyst",		        "version": "1",		        "community": "'+App.auth.getCommunity()+'",		        "loginToken": "'+e+'",		        "verb": "'+d+'",		        "isResponse": false,		        "connectionType": "Wifi",		        "instance": 1,		        "itemCount": 0,                        "timestamp": '+App.utils.newTimeStamp()+',		        "guid": "'+App.utils.newUUID()+'",		        "payloads": [		            {		                "payload": {		                    "isZipped": false,		                    "mimetype": "application/json",		                    "name": "create",		                    "isBase64Encoded": false,		                    '+a.substr(1,a.length-2)+'		                }		            },		            {		                "payload": {		                    "isZipped": false,		                    "mimetype": "application/json",		                    "name": "update",		                    "isBase64Encoded": false,		                    '+b.substr(1,b.length-2)+'		                }		            },		            {		                "payload": {		                    "isZipped": false,		                    "mimetype": "application/json",		                    "name": "delete",		                    "isBase64Encoded": false,		                    "payloadText": "'+c+'"		                }		            }		        ]		    }';$.ajax({type:"POST",url:App.media.restURL+"mcRest",data:{data:f}}).success(function(a,b,c){if(console.log("item saved on server: "+c.responseText),"object"!=typeof a)var d=JSON.parse(App.auth.toUTF8(a));else var d=a;for(var e=0;e<d.payloads.length;e++)d.payloads[e].payload.payloadText&&(d.payloads[e].payload.payloadData=JSON.parse(d.payloads[e].payload.payloadText));Mediator.publish("payloadSubmitted")}).error(function(a){var b;b=0==a.status?"We're sorry, your item was not submitted. Please make sure that you're connected to the internet and try again.":500==a.status?"We're sorry, the server encounted an error while processing your item. Please try again.":503==a.status?"We're sorry, the server is currently unavailable. Please wait a moment and try submitting your item again.":"We're sorry, an unknown error has occured while saving your item.",Mediator.publish("payloadFailed",b)})},saveMedia:function(a,b){if(void 0!==a.data.name&&null!==a.data.name&&(-1!==a.data.name.indexOf(".mp4")&&(a.data.contentType="video/mp4"),-1!==a.data.name.indexOf(".pdf")&&(a.data.contentType="application/pdf"),-1!==a.data.name.indexOf(".txt")&&(a.data.contentType="text/plain"),-1!==a.data.name.indexOf(".png")&&(a.data.contentType="image/png"),-1!==a.data.name.indexOf(".jpg")&&(a.data.contentType="image/jpeg")),void 0!==a.headers.id&&null!==a.headers.id)if(null!==b&&void 0!==b)this.sendPayload("[]","[]",JSON.stringify([a.headers.id])),a.headers={clientId:App.utils.newUUID(),createdAt:Date.now(),updatedAt:Date.now(),action:"Create"},console.log("Resaving Document"),this.saveMedia(a,b);else{a.data.updatedAt=App.utils.isoTimestamp(),a.data.updatedBy=App.auth.getUserId(),a.headers.revisionId=App.utils.newUUID(),a.headers.action="Update",a.headers.updatedAt=App.utils.longTimestamp(),"undefined"==typeof a.headers.createdAt&&(a.headers.createdAt=App.utils.longTimestamp());var c=_.isEmpty(a.data.description)?_.isEmpty(a.data.fileName)?a.headers.mediaId:a.data.fileName:a.data.description;App.socket.query("liquidServer",{command:"upsert",items:[a]},function(a){null!==a?Indicator.danger("Failed to save Media "+c+": "+a.toString()):(Indicator.stop(),console.log("Media Abstract Saved"),Indicator.success("Media "+c+" was saved successfully."))})}else a.data.updatedAt=(new Date).getTime(),a.data.updatedBy=App.auth.getUserId(),a.data.createdBy=App.auth.getUserId(),this.createMediaOnServer(JSON.stringify(a.data),b)},createMediaOnServer:function(a,b){var c=new FormData;c.append("community",App.auth.getCommunity()),c.append("loginToken",App.auth.getToken()),c.append("media",b),c.append("mediaAbstract",a),$.ajax({url:App.config.restUrl+"/ls/external/media",type:"POST",data:c,cache:!1,contentType:!1,processData:!1}).success(function(){console.log("Media Sent to Server - fetching documents"),Indicator.stop(),Indicator.success("Media was successfully uploaded to Liquid Server")}).error(function(a){var b;b=0==a.status?"We're sorry, your document was not submitted. Please make sure that you're connected to the internet and try again.":500==a.status?"We're sorry, the server encounted an error while processing your document. Please try again.":503==a.status?"We're sorry, the server is currently unavailable. Please wait a moment and try submitting your document again.":"We're sorry, an unknown error has occured while saving your document.",Mediator.publish("documentFailed",b),console.log(b+a.status),Indicator.stop(),Indicator.danger("Media was not uploaded to Liquid Server "+b)})}};var DimensionInputView=Backbone.View.extend({data:null,template:null,events:{"click .dimension-select a":"dimensionSelected"},inputElement:null,diffIconElement:null,_compare:null,labelElement:null,buttonElement:null,listElement:null,dimensionSelectedCallback:null,readOnly:!1,dimensionsByPath:{},selectedDimension:null,initialize:function(a){this.data={},this.template=$("#DimensionInputView").html(),this.setElement($(ejs.render(this.template,a))),this.labelElement=$(this.el).find(".view-control-label"),this.inputElement=$(this.el).find(".view-control-input"),this.diffIconElement=$(this.el).find(".view-control-difficon"),this.buttonElement=$(this.el).find(".view-control-button"),this.listElement=$(this.el).find(".view-control-list")},name:function(a){return _.isUndefined(a)?this.inputElement.prop("name"):this.inputElement.prop("name",a)},label:function(a){return _.isUndefined(a)?this.labelElement.html():this.labelElement.html(a)},enabled:function(a){return _.isUndefined(a)?this.buttonElement.prop("disabled"):this.buttonElement.prop("disabled",!a)},val:function(a){return _.isUndefined(a)?this.inputElement.val():this.inputElement.val(a)},compare:function(a){if(_.isUndefined(a))return this._compare;switch(a){case"different":case"added":case"removed":this.diffIconElement.removeClass("glyphicon-ok").removeClass("glyphicon-darkgray").addClass("glyphicon-exclamation-sign").addClass("glyphicon-orange");break;default:this.diffIconElement.removeClass("glyphicon-orange").removeClass("glyphicon-exclamation-sign").addClass("glyphicon-ok").addClass("glyphicon-darkgray")}this._compare=a},dimensionSelected:function(a){{var b=$(a.target),c=b.data("path");b.text()}if(!_.isNull(this.dimensionSelectedCallback)){var d=this.dimensionsByPath[c];this.selectedDimension=d,this.dimensionSelectedCallback(null,this,d)}},level:function(a,b){if(_.isUndefined(a))return this.data.level;var c=this.val();this.enabled(!1),this.val("Loading..."),this.data.level=a,this.data.attributes=b;var d=this;DimensionManager.dimensionsAtLevel(a,b,function(a){if(void 0!==a){var b=a[d.data.selectedPath];void 0!==b?(d.val(b.display),d.selectedDimension=b):d.val(c);var e=_.values(a);if(0!=e.length){var f="";e.forEach(function(a){d.dimensionsByPath[a.path]=a,f+='<li><a data-path="'+a.path+'">'+a.display+"</a></li>"}),d.listElement.html(f),d.readOnly||d.enabled(!0)}}})},reload:function(a){this.readOnly=a,this.level(this.data.level,this.data.attributes)}}),DimensionSelectView=Backbone.View.extend({spinner:null,treeView:null,events:{},initialize:function(a){this.data=a.data;var b=$("#TreeRoot").html(),c=ejs.render(b,{label:this.data.label});$(this.el).find("#dimensionTree").html(c)},willShow:function(){},didShow:function(){var a=$(this.el).find("#dsContent"),b=this;this.treeView=new DimensionTreeView({el:"#dimensionTree",level:this.data.level,attributes:this.data.attributes,expanded:!0,schemaField:this.data.schemaField,selectedHandler:function(a){void 0!==b.data.selectedHandler&&b.data.selectedHandler(a),$(b.el).modal("hide")}}),a.show("fast")},willHide:function(){},didHide:function(){},render:function(){}}),DimensionTreeInputView=Backbone.View.extend({data:null,template:null,events:{"click .view-control-button":"selectBtnPressed"},inputElement:null,diffIconElement:null,_compare:null,labelElement:null,buttonElement:null,dimensionSelectedCallback:null,readOnly:!1,initialize:function(a){this.data={},this.template=$("#DimensionTreeInputView").html(),this.setElement($(ejs.render(this.template,a))),this.labelElement=$(this.el).find(".view-control-label"),this.inputElement=$(this.el).find(".view-control-input"),this.diffIconElement=$(this.el).find(".view-control-difficon"),this.buttonElement=$(this.el).find(".view-control-button")},name:function(a){return _.isUndefined(a)?this.inputElement.prop("name"):this.inputElement.prop("name",a)},label:function(a){return _.isUndefined(a)?this.labelElement.html():this.labelElement.html(a)},enabled:function(a){return _.isUndefined(a)?this.buttonElement.prop("disabled"):this.buttonElement.prop("disabled",!a)},val:function(a){return _.isUndefined(a)?this.inputElement.val():this.inputElement.val(a)},compare:function(a){if(_.isUndefined(a))return this._compare;switch(a){case"different":case"added":case"removed":this.diffIconElement.removeClass("glyphicon-ok").removeClass("glyphicon-darkgray").addClass("glyphicon-exclamation-sign").addClass("glyphicon-orange");break;default:this.diffIconElement.removeClass("glyphicon-orange").removeClass("glyphicon-exclamation-sign").addClass("glyphicon-ok").addClass("glyphicon-darkgray")}this._compare=a},selectBtnPressed:function(){var a=this;App.presentModalPage("DimensionSelectView",{level:this.data.level,label:this.buttonElement.text(),attributes:this.data.attributes,schemaField:this.data.schemaField,selectedHandler:function(b){_.isNull(a.dimensionSelectedCallback)||a.dimensionSelectedCallback(null,a,b)}})},level:function(a,b){if(_.isUndefined(a))return this.data.level;this.data.level=a,this.data.attributes=b;var c=this.data.selectedPath;if(_.isUndefined(c)||0===c.length)return void(this.readOnly||this.enabled(!0));this.enabled(!1),this.val("Loading...");var d=this;DimensionManager.dimensionForPath(c,function(a){if(void 0!==a&&void 0!==a[c]){var b=a[c];d.val(b.display)}else d.val(c);d.readOnly||d.enabled(!0)})},reload:function(a){this.readOnly=a,this.level(this.data.level,this.data.attributes)}});DimensionTreeView.prototype.loadNodeChildren=function(a){a.showSpinner();var b=$(a.el).closest("li").data("path"),c=$(a.el).closest("li").data("level"),d=this;a===this.rootNode?void 0!==b?DimensionManager.childDimensionsForPath(b,this.attributes,function(b){a.removeSpinner(),d.loadDimensions(a,_.values(b))}):void 0!=c&&(_.isUndefined(this.schemaField)||_.isUndefined(this.schemaField.function)||_.isUndefined(this.schemaField.function)?DimensionManager.dimensionsAtLevel(c,this.attributes,function(b){a.removeSpinner(),d.loadDimensions(a,_.values(b))}):(console.log("Testing"),App.socket.query("customFunction",{name:this.schemaField.function,args:{level:c,attributes:this.attributes}},function(b,c){a.removeSpinner(),d.loadDimensions(a,c)}))):void 0!==b?DimensionManager.childDimensionsForPath(b,this.attributes,function(b){a.removeSpinner(),d.loadDimensions(a,_.values(b))}):void 0!=c&&DimensionManager.childDimensionsForLevel(c,this.attributes,function(b){a.removeSpinner(),d.loadDimensions(a,_.values(b))})},DimensionTreeView.prototype.loadDimensions=function(a,b){if(0===b.length)return void a.markLeaf();var c=this,d=$("<ul></ul>");b.forEach(function(a){if(!_.isNull(a)&&!_.isUndefined(a)){var b=a.display;if((_.isNull(b)||0===b.trim().length)&&(b=a.path),!_.isNull(b)&&0!==b.trim().length){var e=c.createNodeEntry(b,a.path);c.dimensionsByPath[a.path]=a,e.data("path",a.path),d.append(e)}}}),a.setChildren(d)},DimensionTreeView.prototype.createNodeEntry=function(a){var b=$("#TreeNode").html(),c=$(ejs.render(b,{label:a}));return c};var DiscussionChannelView=Backbone.View.extend({messageList:null,messageInput:null,topic:null,events:{"keypress #messageInput":"keypressed","click #sendBtn":"sendBtnPressed"},initialize:function(){this.messageList=$(this.el).find("#messageList"),this.messageInput=$(this.el).find("#messageInput"),this.scrollToBottom(),this.topic=new App.Topic("TestTopic");var a=this;this.topic.subscribe(function(b,c){a.renderMessage(c)}),this.topic.onJoin(function(b,c){a.renderInfo(c.userId+" has joined "+c.topic+".")}),this.topic.onLeave(function(b,c){a.renderInfo(c.userId+" has left "+c.topic+".")})},scrollToBottom:function(){$("html, body").animate({scrollTop:$(document).height()},10)},keypressed:function(a){13===a.keyCode&&this.sendBtnPressed()},renderMessage:function(a){var b=$("#DiscussionMessage").html(),c=ejs.render(b,a);this.messageList.append($(c)),this.scrollToBottom()},renderInfo:function(a){var b=$("#DiscussionInfo").html(),c=ejs.render(b,{message:a});this.messageList.append($(c)),this.scrollToBottom()},sendBtnPressed:function(){var a=this.messageInput.val();this.topic.publish({message:a}),this.messageInput.val("")}});DynamicTreeNode.prototype.showSpinner=function(){var a=$(this.el).find('[data-role="spinner"]');0===a.length&&(a=$('<div style="display:inline-block" data-role="spinner">&nbsp;&nbsp;<div class="spinner dashes spinner-mini-white">             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>             <div></div>          </div></div>'),a.appendTo(this.el))},DynamicTreeNode.prototype.removeSpinner=function(){var a=$(this.el).find('[data-role="spinner"]');a.length>0&&$(a).remove()},DynamicTreeNode.prototype.markLeaf=function(){$(this.el).closest("li").find(".glyphicon").removeClass("glyphicon-plus-sign").removeClass("glyphicon-minus-sign").addClass("glyphicon-leaf")},DynamicTreeNode.prototype.isLeaf=function(){return $(this.el).closest("li").find(".glyphicon").hasClass("glyphicon-leaf")},DynamicTreeNode.prototype.setExpanded=function(a){if(!this.isLeaf()){var b=$(this.el).closest("li").find(".glyphicon"),c=$(this.el).closest("li").find("> ul ");a===!0?(b.removeClass("glyphicon-plus-sign"),b.addClass("glyphicon-minus-sign"),c.length>0&&c.show("fast")):(b.removeClass("glyphicon-minus-sign"),b.addClass("glyphicon-plus-sign"),c.length>0&&c.hide("fast"))}},DynamicTreeNode.prototype.toggleExpanded=function(){if(!this.isLeaf()){var a=$(this.el).find(".glyphicon"),b=$(this.el).closest("li").find("> ul ");a.hasClass("glyphicon-plus-sign")?(a.removeClass("glyphicon-plus-sign").addClass("glyphicon-minus-sign"),b.length>0&&b.show("fast")):(a.removeClass("glyphicon-minus-sign").addClass("glyphicon-plus-sign"),b.length>0&&b.hide("fast"))}},DynamicTreeNode.prototype.isExpanded=function(){var a=$(this.el).find(".glyphicon");return a.hasClass("glyphicon-minus-sign")},DynamicTreeNode.prototype.isLoaded=function(){var a=$(this.el).closest("li").find("> ul ");return a.length>0},DynamicTreeNode.prototype.setChildren=function(a){this.removeSpinner();
var b=$(this.el).closest("li").find("> ul ");if(b.length>0)b.replaceWith(a);else{var c=$(a);c.css("display","none"),$(this.el).closest("li").append(c),c.show("fast")}};var DynamicTreeView=Backbone.View.extend({nodePressedHandler:null,nodeSelectedHandler:null,events:{"click li .btn-expand":"nodePressed","click li .btn-select":"nodeSelected"},initialize:function(){},render:function(){return this},nodePressed:function(a){void 0!==this.nodePressedHandler&&null!==this.nodePressedHandler&&this.nodePressedHandler(new DynamicTreeNode(a.target))},createNodeEntry:function(a){return $('<li> <span><i class="glyphicon glyphicon-plus-sign"></i> '+a+'</span> <input type="checkbox">  <a>test</a> </li>')},nodeSelected:function(a){void 0!==this.nodeSelectedHandler&&null!==this.nodeSelectedHandler&&this.nodeSelectedHandler(a)}}),EditFormView=Backbone.View.extend({itemType:null,item:null,file:null,elementsByField:{},dimensionsByLevel:{},events:{"change #fileSelect":"fileSelected","click #SelectCell a":"optionSelected","click #editSaveButton":"saveBtnPressed"},initialize:function(a){null!==App.context.currentItem&&void 0!==App.context.currentItem&&(this.item=App.context.currentItem,this.itemType=this.item.headers.type),"undefined"!=typeof a&&"undefined"!=typeof a.data&&(this.itemType=a.data.itemType)},willShow:function(){},didShow:function(){$("#editFormLabel").html("Edit "+this.itemType),this.buildForm()},willHide:function(){},didHide:function(){},render:function(){},textInput:function(a,b){var c=App.templates.TextInputCell.clone(),d="textInput-"+b,e=c.find("label"),f=c.find("input[type=text]");if(e.text(b),e.prop("for",d),f.attr("id",d),f.prop("placeholder",b),"undefined"!=typeof this.item&&null!==this.item){var g=this.item.data[a];void 0!==g&&null!==g&&g.length>0&&f.val(g)}return c},fileInput:function(){var a=App.templates.FileInputCell.clone();return a},dimensionInput:function(a,b){var c=App.templates.SelectCell.clone(),d=c.find("button #btnTitle");if(d.text(b),"undefined"!=typeof this.item&&null!==this.item){var e=this.item.data[a];void 0!==e&&null!==e&&e.length>0&&c.data("selected",e)}return c},loadDimensions:function(a,b){var c=$(a).find("button");c.prop("disabled",!0);var d=a.data("selected"),e=$(a).find("ul");DimensionManager.dimensionsAtLevel(b,null,function(b){var f=_.values(b),g="",h=null;f.forEach(function(b){if(g+="<li data-path="+b.path+"><a>"+b.display+"</a></li>",void 0!==d&&null!==d&&d.length>0&&d===b.path&&(h=b),null!==h){var f=a.find("input[type=text]");f.val(h.display)}e.html(g),c.prop("disabled",!1)})})},buildForm:function(){var a=Edit[this.itemType],b=a.fields,c=this,d=$(c.el).find("#editFormContent");$.each(b,function(a,b){var e=null;if("text"===b.type)e=c.textInput(b.field,b.label);else if("file"===b.type)e=c.fileInput();else if("dimension"===b.type){var f=c.dimensionInput(b.field.toLowerCase(),b.label),e=f;c.loadDimensions(f,b.dimensionLevel)}null!==e&&(c.elementsByField[b.field]=e,d.append(e))}),d.show("fast")},fileSelected:function(a){this.file=a.target.files[0],$("#fileSelectText").val(this.file.name)},optionSelected:function(a){var b=$(a.target).text(),c=$(a.target).closest("#SelectCell"),d=$(a.target).closest("li").data("path"),e=c.find("input[type=text]");e.val(b),e.data("path",d)},saveBtnPressed:function(){var a=Edit[this.itemType],b=a.fields,c=this;if("undefined"==typeof this.item||null===this.item){var d=App.utils.newUUID;this.item={headers:{type:this.itemType,clientId:d},data:{}}}$.each(b,function(a,b){var d=c.elementsByField[b.field];if(void 0!==d&&null!==d){var e=null;if("text"===b.type){var f=d.find("input[type=text]");e=f.val()}else if("file"===b.type&&null!==c.file)void 0!==b.nameField&&(c.item.data[b.nameField]=c.file.name),void 0!==b.otherNameField&&(c.item.data[b.otherNameField]=c.file.name),void 0!==b.sizeField&&(c.item.data[b.sizeField]=c.file.size);else if("dimension"===b.type){var g=d.find("input[type=text]"),h=g.data("path");e=h}null!==e&&void 0!==e&&e.length>0&&(c.item.data[b.field]=e)}}),"undefined"==typeof this.item.headers.clientId&&(this.item.headers.clientId=App.utils.newUUID()),Indicator.start(),"MediaAbstract"===this.item.headers.type&&App.media.saveMedia(this.item,this.file),$(this.el).modal("hide")}}),LibraryView=Backbone.View.extend({query:null,items:[],events:{"click #libraryLoadMoreBtn":"loadMore","click #mediaList li a":"actionSelected","click .imageLink":"imagePressed","click img":"imagePressed","click #newMediaBtn":"newMediaBtnPressed","click #librarySearchBtn":"searchBtnPressed","keyup #librarySearchInput[type=text]":"searchKeyPressed"},initialize:function(){this.defineQuery()},defineQuery:function(a){this.query=new SocketStreamQuery({namespace:"daltile",category:"content",itemType:"MediaAbstract",sortBy:"updatedat",pageSize:96,search:a,queryFilter:[[{field:"mediatype",value:"/Data/mediaType[Thumbnail]",comparison:"ne"},{field:"mediatype",comparison:"in"}]]})},willShow:function(){App.navBar.setNavBtnActive("LibraryView"),this.loadMore()},didShow:function(){},willHide:function(){},didHide:function(){},render:function(){},loadMore:function(){Indicator.start();var a=this;this.query.next(function(b,c){a.loadResults(b,c)})},loadResults:function(a){if(void 0===a||null===a||0===a.length)return void Indicator.stop();var b=$("#MediaCellView").html(),c=App.config.protocol+"://"+App.config.host+"/ls/external/media?community="+App.auth.getCommunity(),d=$("#mediaList");$.merge(this.items,a),$.each(a,function(a,e){var f,g=c+"&mediaId="+e.data.mediaId,h=c+"&mediaId="+e.data.mediaId+"&thumbnail=true";"/Data/mediaType[Video]"===e.data.mediaType&&(f="lightvideo[|width:840px; height:700px;]");var i;if("undefined"!=typeof e.data.updatedAt){var j=moment(e.data.updatedAt);i=j.format("MMMM Do YYYY, h:mm a")}else i="N/A";var k=$(ejs.render(b,{mediaAbstract:e,fileSize:App.utils.fileSizeString(e.data.fileSize),updatedAt:i,thumbnailUrl:h,imageUrl:g,rel:f,description:_.isEmpty(e.data.description)?_.isEmpty(e.data.name)?e.data.fileName:e.data.Name:e.data.description}));k.data("index",a),d.append(k)}),Indicator.stop()},actionSelected:function(a){var b=$(a.target).text(),c=$(a.target).closest('div[data-role="view"]'),d=c.data("index"),e=this.items[d];switch(App.context.currentItem=e,b){case"Edit":App.presentModalPage("EditFormView");break;case"Delete":var f=_.isEmpty(e.data.description)?_.isEmpty(e.data.fileName)?e.headers.mediaId:e.data.fileName:e.data.description;bootbox.confirm("Are you sure you want to delete "+f+"?",function(a){a&&App.socket.query("liquidServer",{command:"delete",itemIds:[e.headers.id]},function(a){null!==a?(console.log("Error Deleting Media Abstract: "+a),Indicator.danger("Failed to delete Media "+f+": "+a.toString())):(console.log("Media Abstract Deleted"),Indicator.success("Media "+f+" was deleted successfully."))})})}},imagePressed:function(a){var b=$(a.target),c=b.data("mediatype");switch(c){case"/Data/mediaType[Quote]":case"/Data/mediaType[PDF]":window.open(b.data("remote"),"_self");break;case"/Data/mediaType[Video]":window.open(b.data("remote"),"_self");break;default:$(a.target).ekkoLightbox({type:"image"})}},newMediaBtnPressed:function(){App.context.currentItem=null,App.presentModalPage("EditFormView",{itemType:"MediaAbstract"})},searchBtnPressed:function(){var a=$("#librarySearchInput").val();0===a.length&&(a=void 0),console.log(a),this.defineQuery(a),$("#mediaList").html(""),this.items=[],this.loadMore()},searchKeyPressed:function(a){if(13===a.keyCode)this.searchBtnPressed();else if(8===a.keyCode||46===a.keyCode){var b=$(a.target).val();0===b.length&&this.searchBtnPressed()}}}),LoginView=Backbone.View.extend({spinner:null,events:{"click #signInButton":"attemptLogin","keypress input[type=text]":"filterOnEnter","keypress input[type=password]":"filterOnEnter","click #communityList a":"communitySelected","click #resetBtn":"reset"},init:function(){},willShow:function(){this.reset()},didShow:function(){},willHide:function(){},didHide:function(){},render:function(){},filterOnEnter:function(a){if(13===a.keyCode){var b=$(a.currentTarget).attr("id");"userNameTextField"===b?$(this.el).find("#passwordTextField").focus():this.attemptLogin()}},attemptLogin:function(){$("#userNameTextField").prop("disabled",!0),$("#passwordTextField").prop("disabled",!0),$("#signInButton").prop("disabled",!0);var a=$(this.el).find("#userNameTextField").val(),b=$(this.el).find("#passwordTextField").val(),c=this;Indicator.start(),App.socket.query("auth",{userId:a,password:b},function(a,b){"undefined"==typeof a||null===a?(App.auth.communities=b.communities,App.auth.setUserId(b.userId),App.auth.setToken(b.token),App.auth.setSid(b.sid),c.loginSuccess(),c.showCommunities()):c.loginFailure("Authentication Failed:  Invalid Credentials")})},loginSuccess:function(){Indicator.stop()},loginFailure:function(a){Indicator.danger(a),Indicator.stop(),this.reset()},reset:function(){$("#communityBtn").prop("disabled",!0),$("#userNameTextField").prop("disabled",!1).val(""),$("#passwordTextField").prop("disabled",!1).val(""),$("#signInButton").prop("disabled",!1),$(this.el).find("#userNameTextField").focus()},showCommunities:function(){for(var a="",b=0;b<App.auth.communities.length;b++){var c=App.auth.communities[b];a+="<li><a>"+c+"</a></li>"}$("#communityList").html(a),$("#communityBtn").prop("disabled",!1).dropdown("toggle")},communitySelected:function(a){var b=$(a.target).text(),c=App.auth.getSid(),d=this;App.socket.query("setCommunity",{community:b,sid:c},function(a,b){"undefined"==typeof a||null===a?(App.auth.setCommunity(b.community),window.location.href="/"):d.loginFailure("Authentication Failed:  Invalid Credentials")})}}),NavBarView=Backbone.View.extend({query:null,events:{"click #logoutButton":"logoutBtnPressed","click .navbar-left li":"navBtnPressed"},init:function(){var a=this;Mediator.subscribe("CredentialsUpdated",function(){a.updateUserInfo()},this)},willShow:function(){this.updateUserInfo()},didShow:function(){},willHide:function(){},didHide:function(){},render:function(){},navBtnPressed:function(a){var b=$(a.target).closest("li");b.closest("ul").find("li").each(function(a,b){$(b).removeClass("active")}),b.addClass("active")},logoutBtnPressed:function(){App.auth.logout()},updateUserInfo:function(){$("#navMessage").text(App.auth.getUserId()+" ("+App.auth.getCommunity()+")")},setNavBtnActive:function(a){$(".navbar-left li").each(function(b,c){var d=$(c);d.data("page")===a?d.hasClass("active")||d.addClass("active"):d.removeClass("active")})}}),TextInputView=Backbone.View.extend({data:null,template:null,events:{"change .view-control-input":"textChanged"},inputElement:null,diffIconElement:null,_compare:null,labelElement:null,textChangedCallback:null,initialize:function(a){this.data={},_.isUndefined(a)&&(a={}),_.isUndefined(a.type)&&(a.type="text"),this.template=$("#TextInputView").html(),this.setElement($(ejs.render(this.template,a))),this.labelElement=$(this.el).find(".view-control-label"),this.inputElement=$(this.el).find(".view-control-input"),this.diffIconElement=$(this.el).find(".view-control-difficon")},type:function(){return this.params.type},name:function(a){return _.isUndefined(a)?this.inputElement.prop("name"):this.inputElement.prop("name",a)},label:function(a){return _.isUndefined(a)?this.labelElement.html():this.labelElement.html(a)},enabled:function(a){return _.isUndefined(a)?this.inputElement.prop("disabled"):this.inputElement.prop("disabled",!a)},val:function(a){return _.isUndefined(a)?this.inputElement.val():this.inputElement.val(a)},compare:function(a){if(_.isUndefined(a))return this._compare;switch(a){case"different":case"added":case"removed":this.diffIconElement.removeClass("glyphicon-ok").removeClass("glyphicon-darkgray").addClass("glyphicon-exclamation-sign").addClass("glyphicon-orange");break;default:this.diffIconElement.removeClass("glyphicon-orange").removeClass("glyphicon-exclamation-sign").addClass("glyphicon-ok").addClass("glyphicon-darkgray")}this._compare=a},textChanged:function(){_.isNull(this.textChangedCallback)||this.textChangedCallback(null,this)}}),WFCreateView=Backbone.View.extend({spinner:null,prev:null,curr:null,diff:null,approval:null,wfFormView:null,events:{"click #closeBtn":"closeBtnPressed","click #verifyBtn":"verifyBtnPressed","click #submitBtnBottom":"submitBtnPressed","click #verifyBtnBottom":"verifyBtnPressed","click #submitBtn":"submitBtnPressed"},initialize:function(a){this.data=a.data,$("#createValidationMessage").hide(),this.wfFormView=new WFFormView({el:$("#WorkflowFormView")}),Indicator.start();var b=App.config.options.itemId;"undefined"!=typeof App.config.accountId&&(b=App.config.accountId),this.wfFormView.formType=_.isUndefined(b)||_.isNull(b)?"create":"edit";var c=this;App.socket.query("createWorkflow",{accountId:b},function(a,b){c.wfFormView.load(b,function(){var a=b.prev.data.name;$("#createWorkflowTitle").text(a.length>0?b.workflow.data.approvalId.substr(0,8)+" - "+a:b.workflow.data.approvalId.substr(0,8)),$("#workflowTypeTitle").text(0===b.prev.data.accountId.length?"New Workflow:":"Change Workflow:"),c.wfFormView.renderForm()})})},willShow:function(){App.config.embedded?$("#mainNavBar").hide():App.navBar.setNavBtnActive("WFListView")},didShow:function(){},willHide:function(){},didHide:function(){},render:function(){},loadSteps:function(a){$("#stepList").html('<li class="list-group-item list-group-item-info">Steps:</li>');for(var b=0;b<a.length;b++){var c=a[b],d='<li class="list-group-item">'+c.userid+"<br />"+c.positiontype+"</li>";$("#stepList").append(d)}},resetValidationMessages:function(){var a=$("#createValidationMessage");a.show();var b=a.find("#validationMessages");return b.html(""),b},verifyBtnPressed:function(){var a=this;if(!this.hasChanges(this.wfFormView.diff)){$("#createValidationMessage").show();var b=$("#validationMessages");return b.html("<p>Cannot Verify without modifications</p>"),void window.scrollTo(0,0)}this.wfFormView.isFormValid(function(b,c,d){if(!c){var e=a.resetValidationMessages();return void 0!=typeof d&&null!==d&&d.length>0&&d.forEach(function(a){e.append(a+"<br />")}),void window.scrollTo(0,0)}$("#createValidationMessage").hide(),Indicator.start(),App.socket.query("verifyWorkflow",{workflow:a.wfFormView.approval,prev:a.wfFormView.prev,curr:a.wfFormView.curr},function(b,c){if(_.isNull(b))a.loadSteps(c.approvers);else{console.log(b);var d=a.resetValidationMessages();c.forEach(function(a){d.append(a+"<br />")})}Indicator.stop()})})},closeBtnPressed:function(){delete App.config.options.itemId,delete App.config.accountId;var a=_.isUndefined(this.data)||_.isUndefined(this.data.fromPage)?!1:!0;_.isUndefined(App.config.embedded)||App.config.embedded!==!0||a?App.loadPage("WFListView"):window.location.href="inapp://close"},hasChanges:function(a){for(var b=!1,c=Object.keys(a),d=0;d<c.length;d++){var e=c[d],f=a[e];if("stepId"!==e&&"stepOrder"!==e){if(_.isObject(f))for(var g=Object.keys(f),h=0;h<g.length;h++){var i=f[g[h]];if(b=this.hasChanges(i.fields),b===!0)break}else _.isString(f)&&"same"!==f&&(b=!0);if(b===!0)break}}return b},submitBtnPressed:function(){if(!this.hasChanges(this.wfFormView.diff)){$("#createValidationMessage").show();var a=$("#validationMessages");return a.html("<p>Cannot Submit without modifications</p>"),void window.scrollTo(0,0)}var b=this;this.wfFormView.isFormValid(function(a,c,d){if(!c){$("#createValidationMessage").show();var e=$("#validationMessages");return e.html(""),void 0!=typeof d&&null!==d&&d.length>0&&d.forEach(function(a){e.append("<p>"+a+"</p>")}),void window.scrollTo(0,0)}$("#createValidationMessage").hide(),Indicator.start(),App.socket.query("submitWorkflow",{workflow:b.wfFormView.approval,prev:b.wfFormView.prev,curr:b.wfFormView.curr,create:!0},function(a,c){if(Indicator.stop(),_.isNull(a))console.log("Workflow success!"),delete App.config.options.itemId,delete App.config.accountId,App.loadPage("WFListView");else{console.log(a);var d=b.resetValidationMessages();c.forEach(function(a){d.append(a+"<br />")})}})})}}),WFDetailView=Backbone.View.extend({adminMode:!1,spinner:null,steps:[],activeStep:null,activeStepElement:null,wfFormView:null,events:{"click #closeBtn":"closeBtnPressed","click #submitBtn":"submitBtnPressed","click #rejectBtn":"rejectBtnPressed","click #stepList li":"stepSelected","click #rejectBtnBottom":"rejectBtnPressed","click #submitBtnBottom":"submitBtnPressed"},initialize:function(a){var b=this;$("#detailValidationMessage").hide(),this.data=a.data,_.isUndefined(this.data)||_.isUndefined(this.data.param)&&_.isUndefined(this.data.item)?App.loadPage("WFListView"):_.isUndefined(this.data.item)&&!_.isUndefined(this.data.param)?SocketStream.fetchAll({namespace:"dc",category:"workflow",itemType:"wfApproval",sortBy:"updatedAt",faultBlocks:!1,pageSize:20,queryFilter:[[{field:"approvalId",value:this.data.param,comparison:"e"}]]},function(a){return _.isUndefined(a)||0===a.length?void App.loadPage("WFListView"):(b.data.item=a[0],void b.initSteps())}):_.isUndefined(this.data.item)?App.loadPage("WFListView"):b.initSteps()},initSteps:function(){this.stepQuery=new SocketStreamQuery({namespace:"dc",category:"workflow",itemType:"wfStep",sortBy:"steporder",faultBlocks:!0,pageSize:20,queryFilter:[[{field:"workflowId",value:this.data.item.data.approvalId,comparison:"e"}]]}),Indicator.start(),this.wfFormView=new WFFormView({el:$("#DetailWorkflowFormView")}),this.wfFormView.formType=_.isUndefined(this.data.item.data.accountId)||_.isNull(this.data.item.data.accountId)?"create":"edit";var a=this;this.stepQuery.next(function(b,c){a.steps=_.union(a.steps,b);var d=_.findIndex(a.steps,function(a){return"Active"===a.data.stepState});d=-1===d?1:d,a.activeStep=a.steps[d],a.loadSteps(b,c),d>0&&a.compare(a.steps[d-1],a.steps[d]),Indicator.stop()})},willShow:function(){App.config.embedded?$("#mainNavBar").hide():App.navBar.setNavBtnActive("WFListView")},didShow:function(){},willHide:function(){},didHide:function(){},render:function(){},compare:function(a,b){Indicator.start();var c=this;c.wfFormView.clearForm(),App.socket.query("compareSteps",{prev:a,curr:b},function(a,b){("undefined"==typeof a||null===a)&&c.wfFormView.load(b,function(){c.adminMode||c.wfFormView.curr.data.approver.toLowerCase()===App.auth.getUserId().toLowerCase()&&"Submit"!==c.data.item.data.state&&"Processed"!==c.data.item.data.state&&"Rejected"!==c.data.item.data.state?(c.wfFormView.disabled=!1,$("#rejectBtn").prop("disabled",!1),$("#submitBtn").prop("disabled",!1),$("#rejectBtnBottom").prop("disabled",!1),$("#submitBtnBottom").prop("disabled",!1)):(c.wfFormView.disabled=!0,$("#rejectBtn").prop("disabled",!0),$("#submitBtn").prop("disabled",!0),$("#rejectBtnBottom").prop("disabled",!0),$("#submitBtnBottom").prop("disabled",!0)),c.wfFormView.approval=c.data.item;var a=b.prev.data.name;$("#workflowTypeTitle").text(_.isUndefined(b.prev.data.accountId)||_.isNull(b.prev.data.accountId||0===b.prev.data.accountId.length)?"New Workflow:":"Change Workflow:"),$("#detailWorkflowTitle").text(!_.isUndefined(a)&&!_.isNull(a)&&a.length>0?c.data.item.data.approvalId.substr(0,8)+" - "+a:c.data.item.data.approvalId.substr(0,8)),c.wfFormView.renderForm()})})},fetchMoreSteps:function(){Indicator.start();var a=this;this.stepQuery.next(function(b,c){a.steps=_.union(a.steps,b),a.loadSteps(b,c)})},loadSteps:function(a){var b=$("#StepCell").html(),c=this;a.forEach(function(a,d){if(0!==a.data.stepOrder){var e=ejs.render(b,{item:a}),f=$(e);(_.isUndefined(c.activeStep)&&1===d||a===c.activeStep)&&(f.addClass("active").addClass("text-white"),c.activeStepElement=f),$("#stepList").append(f)}})},closeBtnPressed:function(){App.loadPage("WFListView")},submitBtnPressed:function(){var a=this;this.wfFormView.isFormValid(function(b,c,d){if(!c){var e=$("#detailValidationMessage");e.show();var f=e.find("#validationMessages");return f.html(""),!_.isUndefined(d)&&null!==d&&d.length>0&&d.forEach(function(a){f.append(a+"<br />")}),void window.scrollTo(0,0)}$("#detailValidationMessage").hide(),Indicator.start(),App.socket.query("submitWorkflow",{workflow:a.data.item,curr:a.wfFormView.curr},function(a,b){if("undefined"==typeof a||null===a)console.log("Workflow success!"),App.loadPage("WFListView");else{console.log("Workflow failure!");var c=$("#detailValidationMessage");c.show();var d=c.find("#validationMessages");d.html(""),b.forEach(function(a){d.append(a+"<br />")})}Indicator.stop()})})},rejectBtnPressed:function(){var a=this;bootbox.confirm("Are you sure?",function(b){b&&App.socket.query("rejectWorkflow",{workflow:a.data.item,curr:a.wfFormView.curr},function(){Indicator.stop(),App.loadPage("WFListView")})})},stepSelected:function(a){var b=$(a.target).closest("li"),c=b.data("steporder"),d=this.steps[c];if("Waiting"!==d.data.stepState){null!==this.activeStepElement&&this.activeStepElement.removeClass("active").removeClass("text-white"),this.activeStepElement=b,b.addClass("active").addClass("text-white");var e=this.steps[c-1];"Waiting"===d.data.stepState&&(d=this.activeStep),this.compare(e,d)}}}),WFFormView=Backbone.View.extend({query:null,inputViews:null,forms:null,switches:null,schemasByType:null,disabled:!1,validationRules:null,formType:null,events:{"click .remove-button":"removeBtnPressed","click .undo-button":"undoBtnPressed","click .block-add":"addBtnPressed","click .copyToButton":"copyToButtonPressed","click .check-btn":"checkBtnPressed"},initialize:function(){this.inputViews=[],this.forms=[],this.switches=[]},willShow:function(){},didShow:function(){},willHide:function(){},didHide:function(){},render:function(){},load:function(a,b){this.prev=a.prev,this.curr=a.curr,this.diff=a.diff,this.approval=a.workflow;var c=this;App.socket.query("workflowValidation",{},function(a,d){c.validationRules=_.mapValues(d,function(a){return _.mapValues(a,function(a){return _.mapValues(a,function(a){return _.isObject(a)&&(a.formView=c),a})})}),console.log("workflow validations loaded"),b(null,"success")})},clearForm:function(){this.inputViews.forEach(function(a){a.unbind()}),this.inputViews=[],this.switches.forEach(function(a){a.destroy()}),this.switches=[];var a=this;$.each(this.forms,function(b,c){a.unbindForm(c)});var b=$(this.el);b.hide(),b.html("")},unbindForm:function(a){a.data("validator",null),a.unbind("validate")},isFormValid:function(a){var b=!0,c=[];$.each(this.forms,function(a,c){return c.valid()?void 0:void(b=!1)});var d=Item.findBlock(this.curr.data.addresses,"addressType","/Data/communicationType[CustomerShipTo]");(_.isUndefined(d)||_.isNull(d))&&(b=!1,c.push("At least one ShipTo Address is required."));var e=Item.findBlock(this.curr.data.addresses,"addressType","/Data/communicationType[CustomerBillTo]");(_.isUndefined(e)||_.isNull(e))&&(b=!1,c.push("At least one BillTo Address is required."));var f=Item.findBlock(this.curr.data.phones,"phoneType","/Data/communicationType[Work]");(_.isUndefined(f)||_.isNull(f))&&(b=!1,c.push("At least one Work Phone number is required."));var g=Item.findBlock(this.curr.data.phones,"phoneType","/Data/communicationType[WorkFax]");(_.isUndefined(g)||_.isNull(g))&&(b=!1,c.push("At least one Work Fax number is required.")),a(null,b,c)},renderForm:function(){var a=this;App.socket.query("workflowFormConfig",{formType:this.formType},function(b,c){a.schemasByType=c;var d=$("#wfForm").html(),e=$(ejs.render(d));$(a.el).append(e),a.renderFields(a.diff,a.curr,e.find(".panel-body")),a.forms.push(e),a.validation(e,a.validationRules.wfStep)})},validation:function(a,b){a.validate({rules:b,highlight:function(a){$(a).closest(".form-group").addClass("has-error")},unhighlight:function(a){$(a).closest(".form-group").removeClass("has-error")},onkeyup:function(a){$(a).valid()},errorElement:"div",errorClass:"help-block",errorPlacement:function(a,b){a.insertAfter(b.parent(".input-group").length?b.parent():b)}})},inputTypesForDataType:function(a){var b;switch(a){case"phone":b="tel";break;case"email":b="email";break;case void 0:case"refnum":case"string":b="text"}return b},dependenciesValid:function(a){if(_.isUndefined(a)||_.isNull(a))return!0;var b=this,c=!0;return a.forEach(function(a){var d=DimensionManager.valueForComplexKey(b.curr,a);return _.isUndefined(d)||_.isNull(d)||0===d.length?void(c=!1):void 0}),c},renderFields:function(a,b,c){var d=$("#BlockPanel").html(),e=$("#AddButton").html(),f=$("#CopyToButton").html(),g=$("#SwitchInput").html(),h=($("#DimensionFilterDisplay").html(),this.schemasByType[b.headers.type]);if("undefined"!=typeof h){var i=this;$.each(h.fields,function(h,j){var k=j.name,l=a[k];if(void 0!==j){console.log("Key: "+k);var m=b.data[k];switch(void 0===m&&(m=""),j.dataType){case void 0:case"phone":case"email":case"refnum":case"string":var n=new TextInputView({type:i.inputTypesForDataType(j.dataType)});n.data.item=b,n.val(m),n.label(j.label),n.name(k),n.compare(l),n.enabled(!(i.disabled||"removed"===l||!_.isUndefined(j.readonly)&&j.readonly===!0)),n.textChangedCallback=function(a,b){var c=$(b.el).closest(".input-panel"),d=i.getDiff(c),e=b.name(),f=d.fieldPrev.data[e];f=_.isUndefined(f)?"":f;var g=i.doesMatch(f,b.val())?"same":"different";b.compare(g),d.fieldDiff[e]=g,d.fieldCurr.data[e]=b.val()},c.append(n.el),i.inputViews.push(n);break;case"boolean":var o=$(ejs.render(g,{field:k,label:j.label,value:"undefined"==typeof m?!1:m,compare:l,disabled:i.disabled||"removed"===l}));c.append(o);break;case"dimension":if("undefined"!=typeof j.readonly&&j.readonly===!0){var n=new DimensionTreeInputView;n.data.item=b,n.data.selectedPath=m,n.data.blockType=b.headers.type,n.data.schemaField=j,n.label(j.label),n.name(k),n.compare(l),n.enabled(!1),n.readOnly=!0,n.val("N/A"),n.level(j.dimensionLevel,DimensionManager.parseAttributes(b,j),!0),c.append(n.el),i.inputViews.push(n)}else if(j.multilevel){var p=i.dependenciesValid(j.dependencies),n=new DimensionTreeInputView;n.data.item=b,n.data.selectedPath=m,n.data.blockType=b.headers.type,n.data.schemaField=j,n.label(j.label),n.name(k),n.compare(l),n.enabled(p),n.readOnly=i.disabled||!p||"removed"===l||!_.isUndefined(j.readonly)&&j.readonly===!0,n.level(j.dimensionLevel,DimensionManager.parseAttributes(b,j)),n.dimensionSelectedCallback=function(a,b,c){i.dimensionSelected(a,b,c)},c.append(n.el),i.inputViews.push(n)}else{var p=i.dependenciesValid(j.dependencies),n=new DimensionInputView;n.data.item=b,n.data.selectedPath=m,n.data.blockType=b.headers.type,n.data.schemaField=j,n.label(j.label),n.name(k),n.compare(l),n.enabled(p),n.readOnly=i.disabled||!p||"removed"===l||!_.isUndefined(j.readonly)&&j.readonly===!0,n.level(j.dimensionLevel,DimensionManager.parseAttributes(b,j)),n.dimensionSelectedCallback=function(a,b,c){i.dimensionSelected(a,b,c)},c.append(n.el),i.inputViews.push(n)}break;case"list":if("block"!==j.listElementType||!_.isObject(l))break;var q=Object.keys(l).sort();if($.each(q,function(a,b){var c,e=l[b];if(c="removed"===e.compare?i.blockForid(i.prev.data[k],b):i.blockForid(m,b),void 0!=c){var f=i.disabled;i.disabled||j.display===!1&&(f=!0);var g=ejs.render(d,{label:j.label,blockfield:k,blockindex:c.index,blockid:b,compare:e.compare,disabled:f}),h=$(g);i.renderFields(e.fields,c.block,h.find(".panel-body")),$(i.el).append(h),i.forms.push(h),i.validation(h,i.validationRules[k])}}),!i.disabled&&j.display){var r=ejs.render(e,{label:j.label,field:k,blocktype:j.blockType});$(i.el).append(r)}break;case"copyToButton":if(!_.isUndefined(j.visible)&&!App.condition.test(j.visible,b))break;var r=ejs.render(f,{itemType:j.itemType,field:j.name,label:j.label});c.append(r)}}}),$(this.el).show(),Indicator.stop()}},copyToButtonPressed:function(a){a.preventDefault();var b=$(a.target),c=b.data("itemtype"),d=b.data("field"),e=this.schemasByType[c],f=_.where(e.fields,{name:d})[0],g=_.find(this.curr.data[d],function(a){return App.condition.test(f.visible,a)}),h=_.find(this.curr.data[d],function(a){return App.condition.test(f.target,a)}),i=_.filter(this.inputViews,function(a){return a.data.item===g&&f.copyFields.indexOf(a.name())>-1}),j=_.filter(this.inputViews,function(a){return a.data.item===h&&f.copyFields.indexOf(a.name())>-1});i.forEach(function(a,b){var c=j[b];_.isUndefined(a.selectedDimension)?(c.val(a.val()),_.isUndefined(c.textChangedCallback)||c.textChangedCallback(null,c)):(c.selectedDimension=a.selectedDimension,c.data.selectedPath=a.data.selectedPath,c.val(a.val()),c.data.selectedPath=a.data.selectedPath,_.isUndefined(c.dimensionSelectedCallback)||c.dimensionSelectedCallback(null,c,c.selectedDimension))})},dimensionSelected:function(a,b,c){b.val(_.isEmpty(c.display)?c.path:c.display);var d=$(b.el).closest(".input-panel"),e=this.getDiff(d),f=b.name(),g=_.isUndefined(e.fieldPrev)||_.isUndefined(e.fieldPrev.data)?void 0:e.fieldPrev.data[f];b.data.selectedPath=c.path,g=_.isUndefined(g)?"":g;var h=this.doesMatch(g,c.path)?"same":"different";b.compare(h),e.fieldDiff[f]=h,e.fieldCurr.data[f]=c.path,e.fieldCurr.data[f+"Country"]=c.country;var i=this;_.isUndefined(b.data.schemaField.update)||b.data.schemaField.update.forEach(function(a){var d=a.field,f=a.level,g=DimensionManager.depthForPathOrLevel(f),h=DimensionManager.parentPathForDepth(c.path,g),j=_.filter(i.inputViews,function(a){return a.data.item===b.data.item&&a.name()===d});j.forEach(function(a){_.isUndefined(f)?(a.data.attributes=DimensionManager.parseAttributes(e.fieldCurr,a.data.schemaField),a.reload(!i.dependenciesValid(a.data.schemaField.dependencies))):DimensionManager.dimensionForPath(h,function(c){var f=c[h],g=f.display;_.isUndefined(g)&&(g="N/A"),e.fieldCurr.data[d]=f.path,a.val(g),a.compare(b.compare()),a.data.path=h})})})},blockForid:function(a,b){var c,d=this,e=b.split(":");return $.each(a,function(a,b){d.fixHeaders(b),b.headers.parent_id===e[0]&&b.headers.parent_sequence===parseInt(e[1])&&(c={block:b,index:a})}),c},removeBlockForId:function(a,b){var c=this,d=[],e=b.split(":");return $.each(a,function(a,b){c.fixHeaders(b),(b.headers.parent_id!==e[0]||b.headers.parent_sequence!==parseInt(e[1]))&&d.push(b)}),d},fixHeaders:function(a){void 0!==a.headers&&(void 0!==a.headers.rent_id&&(a.headers.parent_id=a.headers.rent_id),void 0!==a.headers.rent_sequence&&(a.headers.parent_sequence=a.headers.rent_sequence))},getDiff:function(a){if(0!==a.length){var b=a.data("blockfield"),c=a.data("blockid"),d=this.diff[b][c],e=this.blockForid(this.prev.data[b],c),f=this.blockForid(this.curr.data[b],c);return f=void 0===f&&void 0!==e?e.block:f.block,e=void 0===e&&void 0!==f?{}:e.block,{fieldDiff:d.fields,fieldPrev:e,fieldCurr:f}}return{fieldDiff:this.diff,fieldPrev:this.prev,fieldCurr:this.curr}},doesMatch:function(a,b){return a===b?!0:"undefined"!=typeof a&&0===a.length&&b===!1?!0:!1},removeBtnPressed:function(a){var b=$(a.target).closest("form"),c=$(a.target).closest(".block-panel"),d=this.getDiff(c),e=c.data("blockfield"),f=c.data("blockid");d.fieldDiff.compare="removed";for(var g in d.fieldDiff.fields)d.fieldDiff.fields[g]="removed";var h=c.find(".panel-body");c.removeClass("panel-info").addClass("panel-danger"),c.find(".block-message").html(" (Deleted)");var i=c.find(".block-button");i.removeClass("remove-button").addClass("undo-button"),i.html("Undo"),h.html(""),this.curr.data[e]=this.removeBlockForId(this.curr.data[e],f);var j=this.blockForid(this.prev.data[e],f);this.forms=_.reject(this.forms,function(a){return a[0]===b[0]}),this.unbindForm(b),void 0===j?c.remove():this.renderFields(d.fieldDiff,j.block,h)},undoBtnPressed:function(a){var b=$(a.target).closest("form"),c=$(a.target).closest(".block-panel"),d=this.getDiff(c),e=c.data("blockfield"),f=c.data("blockid");d.fieldDiff.compare="same";for(var g in d.fieldDiff.fields)d.fieldDiff.fields[g]="same";var h=c.find(".panel-body");c.removeClass("panel-danger").addClass("panel-info"),c.find(".block-message").html("");var i=c.find(".block-button");i.removeClass("undo-button").addClass("remove-button"),i.html("Remove"),h.html("");var j=this.blockForid(this.prev.data[e],f);this.curr.data[e].push(_.cloneDeep(j.block)),this.renderFields(d.fieldDiff,j.block,h),this.forms.push(b),this.validation(b,this.validationRules[e])},addBtnPressed:function(a){for(var b=$(a.target),c=b.data("blocktype"),d=b.data("field"),e=$("#BlockPanel").html(),f=this,g=f.schemasByType[c],h={headers:{},data:{}},i={},j=0;j<g.fields.length;j++){var k=g.fields[j];
h.data[k.name]="",i[k.name]="added"}var l=this.approval.data.accounthId;h.headers.id=l+":"+this.curr.data[d].length,h.headers.parent_id=l,h.headers.parent_sequence=this.curr.data[d].length,h.headers.parent_fieldname=d,h.headers.parent_type=this.curr.headers.type,h.headers.type=c;var m=ejs.render(e,{label:c,blockfield:d,blockindex:h.headers.parent_sequence,blockid:h.headers.id,compare:"added"}),n=$(m);this.curr.data[d].push(h),this.diff[d][h.headers.id]={compare:"added",fields:i},this.renderFields(i,h,n.find(".panel-body")),b.parent().before(n),f.forms.push(n),f.validation(n,f.validationRules[d])},checkBtnPressed:function(a){var b=$(a.target).closest("button"),c=b.closest(".switchInput"),d=b.find(".glyphicon"),e=b.data("value"),f=b.data("field"),g=c.find("input[type=text]"),h=c.closest(".input-panel"),i=c.find(".input-group-addon i"),j=this.getDiff(h);e=e?!1:!0,b.data("value",e),g.val(e);var k=j.fieldPrev.data[f];j.fieldCurr.data[f]=e,this.doesMatch(k,e)?(j.fieldDiff[f]="same",i.removeClass("glyphicon-exclamation-sign").removeClass("glyphicon-orange").addClass("glyphicon-ok").addClass("glyphicon-darkgray")):(j.fieldDiff[f]="different",i.removeClass("glyphicon-ok").removeClass("glyphicon-darkgray").addClass("glyphicon-exclamation-sign").addClass("glyphicon-orange")),console.log("Field: "+f+" value: "+e),e===!0?(b.removeClass("btn-default").addClass("btn-primary"),d.removeClass("glyphicon-unchecked").addClass("glyphicon-check")):(b.removeClass("btn-primary").addClass("btn-default"),d.removeClass("glyphicon-check").addClass("glyphicon-unchecked"))}}),WFListView=Backbone.View.extend({items:null,query:null,spinner:null,filterBtnGroup:null,config:null,wfListId:[],events:{"click #workflowList li":"workflowPressed","click #loadMoreBtn":"loadMore","click #wfListCloseBtn":"closeBtnPressed","click #wfSearchBtn":"searchBtnPressed","keyup #wfSearchInput[type=text]":"searchKeyPressed","click #newWorkflowBtn":"newWorkflowBtnPressed","click #filterBtnGroup li":"filterSelected","click #refreshBtn":"refreshBtnPressed","click #massApprovalBtn":"massApprovalBtnPressed"},initialize:function(a){this.data=a.data,this.items=[],$(this.el).hide(),this.defineQuery(),$("#workflowMessagesModal").hide();var b=$("#WorkflowHeader").html(),c=ejs.render(b,{column1:"",column2:"Type",column3:"Account Name",column4:"id",column5:"Status",column6:"Requestor",column7:"State"});$("#workflowList").append(c),this.filterBtnGroup=$("#filterBtnGroup");var d=this.filterBtnGroup.find("ul"),e=this.filterBtnGroup.find("button");_.isUndefined(App.config.wfFilterIndex)&&(App.config.wfFilterIndex=0);var f=this;App.socket.query("workflowListConfig",{},function(a,b){f.config=b,f.config.predefinedFilters.forEach(function(a,b){var c=$("<li><a>"+a.label+"</a></li>").data("id",a.id);d.append(c),_.isUndefined(f.data)||_.isUndefined(f.data.param)||a.id===f.data.param&&(App.config.wfFilterIndex=b),b===App.config.wfFilterIndex&&f.applyFilter(c)}),e.removeClass("disabled"),f.loadMore()})},refreshBtnPressed:function(a){$("#workflowMessagesModal").hide(),this.applyCurrentFilter($(a.target)),this.clear(),this.items=[],$("#wfSearchInput").val(""),this.loadMore()},filterSelected:function(a){$("#workflowMessagesModal").hide(),this.applyFilter($(a.target)),this.clear(),this.items=[],$("#wfSearchInput").val(""),this.loadMore()},applyCurrentFilter:function(){var a=App.config.wfFilterIndex;a=_.isUndefined(a)?0:a;var b=this.filterBtnGroup.find("ul"),c=b.find("li:nth-child("+(a+1)+")");this.applyFilter(c)},applyFilter:function(a){var b=a.closest("li"),c=b.data("id"),d=b.index(),e=a.text();App.config.wfFilterIndex=d;var f=this.filterBtnGroup.find("button");f.find(".btn-title").text(e),f.removeClass("disabled");var g=_.find(this.config.predefinedFilters,function(a){return a.id===c});Backbone.history.navigate("#WFListView:"+g.id,{trigger:!1}),this.defineQuery(null,g.sort,g.queryFilter)},clear:function(){var a=$("#WorkflowHeader").html(),b=ejs.render(a,{column1:"",column2:"Type",column3:"Account Name",column4:"id",column5:"Status",column6:"Requestor",column7:"State"});$("#workflowList").html(""),$("#workflowList").append(b)},defineQuery:function(a,b,c){a=_.isNull(a)?void 0:a,b=_.isNull(b)||_.isUndefined(b)?{value:"h_createdat",desc:!0}:b,this.query=new SocketStreamQuery({namespace:"dc",category:"workflow",itemType:"ActiveApprovals",baseItemType:"wfApproval",sortBy:b.value,faultBlocks:!0,pageSize:20,caseInsensitive:!0,desc:b.desc,search:a,queryFilter:c})},willShow:function(){App.config.embedded?$("#mainNavBar").hide():App.navBar.setNavBtnActive("WFListView"),"undefined"!=typeof App.config.options.hideCloseBtn&&App.config.options.hideCloseBtn===!0&&$("#wfListCloseBtn").hide()},didShow:function(){},willHide:function(){},didHide:function(){},render:function(){},loadMore:function(){Indicator.start();var a=this;this.query.next(function(b,c){a.loadResults(b,c)})},loadResults:function(a){this.items=_.union(this.items,a);for(var b=$("#WorkflowCell").html(),c=0;c<a.length;c++){var d=a[c],e=d.data.accountName;(void 0===e||null===e||0===e.length)&&(e=d.data.newName),console.log(d.data),console.log(d.data.h_type);var f=!1;"closed"!=d.data.status.toLowerCase()&&d.data.approver.toLowerCase()==App.auth.getUserId().toLowerCase()&&(f=!0);var g=ejs.render(b,{column1:f,column2:d.data.workflowType,column3a:e,column3b:moment(d.headers.createdat).format("MMMM Do YYYY, h:mm:ss a"),column4:d.data.approvalId.substr(0,8),column5:d.data.status,column6:d.data.requestor,column7:d.data.state,column8:d.data.approvalId});$("#workflowList").append(g)}$(this.el).show(),Indicator.stop()},workflowPressed:function(a){var b=$(a.target).closest("li"),c=$("#workflowList").find("li").index(b)-1,d=this.items[c],e=$(a.target).closest("input[type=checkbox]"),f=!1,g=!1,h="";"undefined"==typeof e[0]?f=!1:(g=e[0].checked,f=!0,h=e[0].id),"undefined"!=typeof d&&(f?this.massApprovalEnabled(g,h):App.loadPage("WFDetailView:"+d.data.approvalId,{item:d}))},closeBtnPressed:function(){App.config.embedded&&(window.location.href="inapp://close")},searchBtnPressed:function(){$("#workflowMessagesModal").hide();var a=$("#wfSearchInput").val();0===a.length&&(a=void 0),this.applyCurrentFilter(),this.query.parameters.search=a,this.clear(),this.items=[],this.loadMore()},searchKeyPressed:function(a){if(13===a.keyCode)this.searchBtnPressed();else if(8===a.keyCode||46===a.keyCode){var b=$(a.target).val();0===b.length&&this.searchBtnPressed()}},massApprovalEnabled:function(a,b){a?this.wfListId.push(b):this.wfListId.indexOf(b)>-1&&this.wfListId.splice(this.wfListId.indexOf(b),1),this.wfListId.length>0?$("#massApprovalBtn").removeAttr("disabled"):$("#massApprovalBtn").attr("disabled","disabled")},newWorkflowBtnPressed:function(){App.loadPage("WFCreateView",{fromPage:"WFListView"})},massApprovalBtnPressed:function(){return $("#workflowErrors").html(""),0==this.wfListId.length?($("#workflowMessagesModal").show(),void $("#workflowErrors").html("Please choose atleast one workflow to approve")):void this.massApprovalSubmit()},massApprovalSubmit:function(){var a=this,b=this.wfListId;$("#workflowMessagesModal").hide(),Indicator.start();var c=[],d=[],e=[],f=[];for(id in b)d.push({field:"approvalId",value:b[id],comparison:"e"}),e.push({field:"workflowId",value:b[id],comparison:"e"});c.push(d),f.push(e);var g=[{field:"approver",value:App.auth.getUserId(),comparison:"e"}];f.push(g);var h={};SocketStream.fetchAll({namespace:"dc",category:"workflow",itemType:"wfApproval",sortBy:"approvalId",faultBlocks:!1,pageSize:a.items.length+1,queryFilter:c},function(b){_.isUndefined(b)||0===b.length?($("#workflowMessagesModal").show(),$("#workflowErrors").html("Error occurred while submitting the workflows try again later"),Indicator.stop()):(h=b,SocketStream.fetchAll({namespace:"dc",category:"workflow",itemType:"wfStep",sortBy:"steporder",faultBlocks:!0,pageSize:a.items.length,queryFilter:f},function(b){console.log(b),console.log(h),App.socket.query("submitMultipleWorkflow",{workflows:h,curr:b,userId:App.auth.getUserId()},function(b,c){var d=$("#workflowMessagesModal");d.show();var e=d.find("#workflowErrors");e.html(""),c.forEach(function(a){if("undefined"!=typeof a.msg){e.append("<div class='alert alert-danger'>"+a.id.substr(0,8)+" is not submitted.<ul class='nav' id='messageList"+a.id.substr(0,8)+"'></ul></div>");var b=e.find("#messageList"+a.id.substr(0,8));a.msg.forEach(function(a){b.append("<li>"+a+"</li>")})}else e.append("<div class='alert alert-success'>"+a.id.substr(0,8)+" &nbsp; is successfully submitted. <br/></div>")}),Indicator.stop(),a.applyCurrentFilter(),a.clear(),a.items=[],$("#wfSearchInput").val(""),a.loadMore()})}))})}});